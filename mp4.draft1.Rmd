---
title: "Mp4.draft1"
author: "Anna Ballou, Nicole Lawler, Jessica Jacinto"
date: "4/29/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE}
library(tidyverse)
library(RMySQL)
library(ggplot2)
db <- dbConnect(MySQL(), 
                host = "scidb.smith.edu", 
                user = "mth292", 
                password = "RememberPi", 
                dbname = "imdb")
knitr::opts_chunk$set(connection = db, max.print = 400)
```

```{r}
db <- dbConnect(MySQL(),
                host = "scidb.smith.edu",
                user = "mth292",
                password = "RememberPi",
                dbname = "imdb")
```
                
```{r}
sql1 <- "
SELECT 
	FLOOR(t.production_year/10) *  10 AS decade,
	mi.info AS genre, 
	COUNT(DISTINCT mi.id) AS num_times
    
FROM movie_info AS mi
INNER JOIN title AS t ON t.id = mi.movie_id
WHERE mi.info_type_id = 3
AND t.production_year >= 1920
AND t.production_year < 2010
AND mi.info <> 'Short'
AND mi.info <> 'Erotica'
AND mi.info <> 'Experimental'
AND mi.info <> 'Lifestyle'
AND mi.info <> 'Sport'
AND mi.info <> 'Talk-Show'
AND mi.info <> 'News'
GROUP BY floor(t.production_year/10) *  10, mi.info
ORDER BY 1,2
;"

db1 <- db %>%
  dbGetQuery(sql1)

print(db1)
```

```{r}
plot1 <- ggplot(data = db1, aes(x = decade, y = num_times)) +
  geom_line() +
  facet_wrap(~genre) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(plot1)
```

```{r}
plot2 <- ggplot(data = db1, aes(x = decade, y = num_times, color = genre)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(plot2)
```

```{sql}
SELECT 
	FLOOR(t.production_year/10) *  10 AS decade,
	COALESCE(mi.info,"Other") AS genre, 
    SUM(CONVERT(
			TRIM(
				REPLACE(
					REPLACE(
						SUBSTRING_INDEX(mi2.info,"(USA)",1) -- split on "USA"
						 ,"$","") -- close replace dollar sign with space
                           , ",", "" ) -- close replace comma with space 
                           ) -- close trim
                           , signed) -- close convert
						) AS Amount -- close sum
FROM title AS t
INNER JOIN movie_info AS mi ON t.id = mi.movie_id
INNER JOIN movie_info AS mi2 ON mi.movie_id = mi2.movie_id
WHERE mi.info_type_id = 3
AND mi2.info_type_id = 107
AND SUBSTRING(mi2.info,1,1) = "$"
AND mi2.info LIKE "%(USA)%"
AND t.production_year >= 1920
AND t.production_year <= 2010
GROUP BY FLOOR(t.production_year/10) *  10, mi.info
ORDER BY 1,2
```






